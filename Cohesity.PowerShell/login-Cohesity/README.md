# Use Stored Passwords with Cohesity.PowerShell

Warning: this code is provided on a best effort basis and is not in any way officially supported or sanctioned by Cohesity. The code is intentionally kept simple to retain value as example code. The code in this repository is provided as-is and the author accepts no liability for damages resulting from its use.

This PowerShell script allows you to securely use stored credentials with the Cohesity.Pwershell cmdlet Connect-CohesityCluster. The script works on Windows, Mac and Linux

Note: the Cohesity.PowerShell cmdlets can be found here: https://cohesity.github.io/cohesity-powershell-module/#/setup

The first time you use the script and use a username to authenticate to a Cohesity cluster, the script will prompt you for your password. The password will be encrypted and stored for later use. The second time you run the script with the same username and cluster, you will not be prompted for your password.

## Components

* login-Cohesity.ps1: the main PowerShell script

You can run the scipt like so:

```powershell
./login-Cohesity.ps1 -Server mycluster -UserName myusername -Domain mydomain.net
Connected to the Cohesity Cluster mycluster Successfully
```

## Optional Parameters

*  -UpdatePassword: (optional) force the script to prompt for a new password
*  -Domain: (optional) defaults to 'local', otherewise enter your AD domain e.g. mydomain.net

## Security Notes

The login-Cohesity.ps1 script uses .Net Secure Strings to store the password in encrypted format. On Windows, the encryption key is auto-generated by a function in CRYPT32.DLL, based on the current user's credentials. 

On Mac/Linux, CRYPT32.DLL is not present, so we need to provide a key to do the encryption. I decided to take a 256-bit slice of the user's ~/.ssh/id_rsa file as the encryption key, for a couple of reasons: 1) this file is stored in a reasonably secure location, 2) It's unique for each user, and 3) almost everyone has this file. 

If you don't have a ~/.ssh/id_rsa file, then you can run ssh-keygen and follow the default prompts. This should create the files ~/.ssh/id_rsa and ~/.ssh/id_rsa.pub

## Download the script

Run these commands from PowerShell to download the script(s) into your current directory

```powershell
(Invoke-WebRequest -Uri https://raw.githubusercontent.com/bseltz-cohesity/scripts/master/Cohesity.PowerShell/login-Cohesity/login-Cohesity.ps1).content | Out-File login-Cohesity.ps1; (Get-Content login-Cohesity.ps1) | Set-Content login-Cohesity.ps1
```
